<div class="app-container" [class.dark]="darkMode()">
  <!-- Global Header -->
  <header class="app-header d-flex align-items-center justify-content-between gap-2 px-3 py-2">
    <div class="d-flex align-items-center gap-2">
      <img src="/icons/icon-48.png" alt="Good Wallet logo" width="44" height="44" class="app-logo" />
      <div class="app-title d-flex align-items-center gap-3">
          <div class="h5 mb-0 fw-bold">GoodWallet</div>
          <!-- Friends button -->
          <button class="btn friends-btn" routerLink="/friends" title="Gestionar amigos">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M19 8v6"></path>
              <path d="M22 11h-6"></path>
            </svg>
            <span class="ms-1">Amigos</span>
          </button>
          <!-- Dark mode switch -->
          <div class="dark-mode-toggle" title="Cambiar modo oscuro/claro">
            <input type="checkbox" id="globalDarkModeToggle" (change)="toggleDarkMode($event)" [checked]="darkMode()" />
            <label for="globalDarkModeToggle" class="toggle-slider">
              <span class="toggle-icon sun">‚òÄÔ∏è</span>
              <span class="toggle-icon moon">üåô</span>
            </label>
          </div>
        </div>
    </div>

    <!-- Header metrics: visible only on SM screens and larger -->
    <div class="header-metrics d-none d-sm-flex align-items-center gap-2" *ngIf="isDashboardRoute()">
      <div class="metric-card bg-balance rounded shadow-sm text-center py-1 px-2">
        <div class="small opacity-75 text-balance">Balance</div>
        <div class="fw-bold text-balance" style="font-size: 0.95rem;">{{ formatDashboardCurrency(getDashboardTotalBalance()) }}</div>
      </div>

      <div class="metric-card bg-prestado rounded shadow-sm text-center py-1 px-2">
        <div class="small opacity-75 text-theme">Prestado</div>
        <div class="fw-bold text-theme" style="font-size: 0.95rem;">{{ formatDashboardCurrency(getDashboardTotalLent()) }}</div>
      </div>

      <div class="metric-card bg-adeudado rounded shadow-sm text-center py-1 px-2">
        <div class="small opacity-75 text-theme">Adeudado</div>
        <div class="fw-bold text-theme" style="font-size: 0.95rem;">{{ formatDashboardCurrency(getDashboardTotalBorrowed()) }}</div>
      </div>
    </div>
  </header>

  <main class="app-main" [class.dark]="darkMode()">
    <router-outlet></router-outlet>
  </main>
  
  <app-bottom-nav *ngIf="!sidebarVisible() && !isAuthPage()" (toggleSidebar)="toggleSidebar()" (toggleAccount)="toggleAccount()"></app-bottom-nav>

  <!-- Left vertical nav (floating) - controlled by SidebarService -->
  <nav *ngIf="sidebarVisible() && !isAuthPage()" class="left-nav" role="navigation" [class.collapsed]="sidebarCollapsed()">
  <a routerLink="/dashboard" routerLinkActive="active" class="nav-item">
      <div class="nav-icon">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M3 13h1v7c0 1.103.897 2 2 2h12c1.103 0 2-.897 2-2v-7h1a1 1 0 0 0 .707-1.707l-9-9a.999.999 0 0 0-1.414 0l-9 9A1 1 0 0 0 3 13z"/></svg>
      </div>
      <span *ngIf="!sidebarCollapsed()" class="nav-label">Dashboard</span>
    </a>
    <a routerLink="/accounts" routerLinkActive="active" class="nav-item">
      <div class="nav-icon">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M2 4v16h20V4H2zm18 14H4V6h16v12z"/><path d="M6 8h4v2H6zm6 0h6v2h-6zm-6 4h4v2H6zm6 0h6v2h-6z"/></svg>
      </div>
      <span class="nav-label">Cuentas</span>
    </a>
    <a routerLink="/loans" routerLinkActive="active" class="nav-item">
      <div class="nav-icon">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2z"/><path d="M11 11h2v6h-2zm0-4h2v2h-2z"/></svg>
      </div>
      <span class="nav-label">Pr√©stamos</span>
    </a>
    <a routerLink="/recurring-transactions" routerLinkActive="active" class="nav-item">
      <div class="nav-icon">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4V1l-4 4 4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8z"/><path d="M12 18c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg>
      </div>
      <span class="nav-label">Recurrentes</span>
    </a>
    <a routerLink="/friends" routerLinkActive="active" class="nav-item">
      <div class="nav-icon">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
      </div>
      <span class="nav-label">Amigos</span>
    </a>
    <!-- Account menu entry -->
    <a class="nav-item" (click)="toggleAccount()" title="Cuenta">
      <div class="nav-icon">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
        </svg>
      </div>
      <span *ngIf="!sidebarCollapsed()" class="nav-label">Cuenta</span>
    </a>
  <!-- Dashboard V2 and Respaldo removed from sidebar per request -->
    <button class="nav-toggle-bottom" (click)="toggleSidebar()" title="Mover abajo">
      ‚§ø
    </button>

    <!-- Collapse control positioned to the right edge of the left nav -->
    <button class="nav-collapse" (click)="toggleCollapse()" title="Expandir/Colapsar" [attr.aria-expanded]="!sidebarCollapsed()">
      <span *ngIf="sidebarCollapsed()">‚ñ∂</span>
      <span *ngIf="!sidebarCollapsed()">‚óÄ</span>
    </button>
  </nav>
  
  <!-- Panel flotante de cuenta -->
  <div *ngIf="accountPanel() && !isAuthPage()" class="account-panel-overlay" (click)="toggleAccount()">
    <div class="account-panel" (click)="$event.stopPropagation()">
      <div class="account-header">
        <div class="account-avatar">{{ getInitials() }}</div>
        <div class="account-info">
          <div class="account-name">{{ auth.currentUser()?.display_name || auth.currentUser()?.email || 'Usuario' }}</div>
          <div class="account-email" *ngIf="auth.currentUser()?.display_name">{{ auth.currentUser()?.email }}</div>
        </div>
      </div>
      <div class="account-actions">
        <button class="account-btn" (click)="openBalanceProjection();" title="Proyecci√≥n de balance">
          <span class="btn-icon">üìà</span>
          Proyecci√≥n de balance
        </button>

        <button class="account-btn" (click)="openBackup();" title="Respaldo de datos">
          <span class="btn-icon">üíæ</span>
          Respaldo
        </button>

        <button class="account-btn logout-btn" (click)="logout(); toggleAccount();">
          <span class="btn-icon">üö™</span>
          Cerrar sesi√≥n
        </button>
      </div>
    </div>
  </div>
  <!-- Notification Toast Component -->
  <app-notification-toast></app-notification-toast>

  <!-- Theme Selector -->
  <app-theme-selector *ngIf="!isAuthPage()"></app-theme-selector>
</div>
