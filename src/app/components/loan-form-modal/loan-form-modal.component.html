@if (isOpen()) {
  <div class="loan-modal-backdrop" (click)="onBackdropClick($event)">
    <div class="loan-modal" (click)="$event.stopPropagation()">
      <div class="loan-modal-header">
        <h3 class="loan-modal-title">Nuevo Pr√©stamo</h3>
        <button type="button" class="btn-close" (click)="closeModal()">‚úï</button>
      </div>

      <!-- Step Indicator -->
      <div class="step-indicator">
        <div class="step-item" [class.active]="currentStep() === 1" [class.completed]="currentStep() > 1">
          <div class="step-number">1</div>
          <div class="step-label">Tipo & Persona</div>
        </div>
        <div class="step-connector" [class.active]="currentStep() > 1"></div>
        <div class="step-item" [class.active]="currentStep() === 2" [class.completed]="currentStep() > 2">
          <div class="step-number">2</div>
          <div class="step-label">Monto & Fechas</div>
        </div>
        <div class="step-connector" [class.active]="currentStep() > 2"></div>
        <div class="step-item" [class.active]="currentStep() === 3" [class.completed]="currentStep() > 3">
          <div class="step-number">3</div>
          <div class="step-label">Detalles & Cuotas</div>
        </div>
        <div class="step-connector" [class.active]="currentStep() > 3"></div>
        <div class="step-item" [class.active]="currentStep() === 4">
          <div class="step-number">4</div>
          <div class="step-label">Resumen</div>
        </div>
      </div>

      <div class="loan-modal-body">
        <!-- STEP 1 -->
        @if (currentStep() === 1) {
          <div class="step-content">
            <div class="form-grid two-cols">
              <div class="form-group full">
                <label>Tipo de pr√©stamo</label>
                <div class="type-options">
                  <button type="button" class="type-card" [class.selected]="formData().type === 'lent'" (click)="updateFormField('type','lent')">
                    <span class="type-icon">ü§ù</span>
                    <span class="type-title">Yo prest√©</span>
                  </button>
                  <button type="button" class="type-card" [class.selected]="formData().type === 'borrowed'" (click)="updateFormField('type','borrowed')">
                    <span class="type-icon">üí∏</span>
                    <span class="type-title">Me prestaron</span>
                  </button>
                </div>
              </div>
              <div class="form-group">
                <label>Persona</label>
                <input type="text" [value]="formData().personName" (input)="onPersonNameChange($event)" placeholder="Nombre de la persona" />
              </div>
              <div class="form-group" style="display: none;">
                <label>Estado</label>
                <select [value]="formData().status" (change)="onStatusChange($event)">
                  <option value="pending">Pendiente</option>
                  <option value="paid">Pagado</option>
                  <option value="overdue">Vencido</option>
                </select>
              </div>
            </div>
          </div>
        }

        <!-- STEP 2 -->
        @if (currentStep() === 2) {
          <div class="step-content">
            <div class="form-grid one-col">
              <div class="form-group amount-group">
                <div class="amount-input-container">
                  <div class="amount-input-wrapper">
                    <label>Monto (PEN)</label>
                    <input type="number" min="0.01" step="0.01" placeholder="0.00" [value]="formData().amount || ''" (input)="onAmountChange($event)" />
                  </div>
                  <div class="amount-buttons">
                    <button type="button" class="amount-btn amount-btn-add" (click)="adjustAmount(0.1)">+0.1</button>
                    <button type="button" class="amount-btn amount-btn-add" (click)="adjustAmount(10)">+10</button>
                    <button type="button" class="amount-btn amount-btn-add" (click)="adjustAmount(20)">+20</button>
                    <button type="button" class="amount-btn amount-btn-subtract" (click)="adjustAmount(-0.1)">-0.1</button>
                    <button type="button" class="amount-btn amount-btn-subtract" (click)="adjustAmount(-10)">-10</button>
                    <button type="button" class="amount-btn amount-btn-subtract" (click)="adjustAmount(-20)">-20</button>
                  </div>
                </div>
              </div>
              <div class="dates-row">
                <div class="form-group">
                  <label>Fecha del pr√©stamo</label>
                  <input type="date" [value]="formData().date" (input)="onDateChange($event)" />
                </div>
                @if (!formData().hasInstallments) {
                  <div class="form-group">
                    <label>Fecha de vencimiento</label>
                    <input type="date" [value]="formData().dueDate" (input)="onDueDateChange($event)" />
                  </div>
                }
                @if (formData().hasInstallments) {
                  <div class="form-group">
                    <label>Primera cuota</label>
                    <input type="date" [value]="formData().firstInstallmentDate" (input)="onFirstInstallmentDateChange($event)" />
                  </div>
                }
              </div>
              <div class="form-group full">
                <label class="inline-checkbox">
                  <input type="checkbox" [checked]="formData().hasInstallments" (change)="onInstallmentsChange($event)" />
                  <span>Pagar en cuotas</span>
                </label>
              </div>
              @if (formData().hasInstallments) {
                <div class="installments-row">
                  <div class="form-group">
                    <label>Frecuencia de pago</label>
                    <select [value]="formData().paymentFrequency" (change)="onPaymentFrequencyChange($event)">
                      <option value="daily">Diario</option>
                      <option value="weekly">Semanal</option>
                      <option value="biweekly">Cada 15 d√≠as</option>
                      <option value="monthly">Mensual</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>N√∫mero de cuotas</label>
                    <input type="number" min="1" max="365" [value]="formData().totalInstallments" (input)="onTotalInstallmentsChange($event)" />
                  </div>
                </div>
                <div class="preview-box full">
                  <div class="preview-line">{{ formData().totalInstallments }} cuotas {{ getFrequencyText() }} de {{ formatCurrency(installmentAmount()) }}</div>
                </div>
              }
            </div>
          </div>
        }

        <!-- STEP 3 -->
        @if (currentStep() === 3) {
          <div class="step-content">
            <div class="form-grid one-col">
              <div class="form-group full">
                <label>Descripci√≥n</label>
                <textarea rows="4" maxlength="200" placeholder="Describe el motivo del pr√©stamo..." [value]="formData().description" (input)="onDescriptionChange($event)"></textarea>
              </div>
            </div>
          </div>
        }

        <!-- STEP 4 (Resumen) -->
        @if (currentStep() === 4) {
          <div class="step-content summary">
            <div class="summary-grid">
              <div class="summary-item"><span class="label">Tipo:</span><span class="value">{{ formData().type === 'lent' ? 'Yo prest√©' : 'Me prestaron' }}</span></div>
              <div class="summary-item"><span class="label">Persona:</span><span class="value">{{ formData().personName }}</span></div>
              <div class="summary-item"><span class="label">Estado:</span><span class="value">{{ formData().status }}</span></div>
              <div class="summary-item"><span class="label">Monto:</span><span class="value">{{ formatCurrency(formData().amount || 0) }}</span></div>
              <div class="summary-item" *ngIf="!formData().hasInstallments"><span class="label">Vencimiento:</span><span class="value">{{ formData().dueDate }}</span></div>
              <div class="summary-item" *ngIf="formData().hasInstallments"><span class="label">Primera cuota:</span><span class="value">{{ formData().firstInstallmentDate }}</span></div>
              <div class="summary-item" *ngIf="formData().hasInstallments"><span class="label">Frecuencia:</span><span class="value">{{ getFrequencyText() }}</span></div>
              <div class="summary-item" *ngIf="formData().hasInstallments"><span class="label">Cuotas:</span><span class="value">{{ formData().totalInstallments }} x {{ formatCurrency(installmentAmount()) }}</span></div>
              <div class="summary-item full"><span class="label">Descripci√≥n:</span><span class="value multiline">{{ formData().description }}</span></div>
            </div>
          </div>
        }
      </div>

      <!-- Footer Navigation -->
      <div class="loan-modal-footer">
        <div class="footer-layout-wrapper">
          <div class="footer-center">
            <button type="button" class="btn btn-sm btn-cancel" (click)="closeModal()">Cancelar</button>
          </div>
          <div class="footer-navigation">
            <div class="footer-left">
              <button type="button" class="btn btn-sm btn-prev" (click)="prevStep()" [disabled]="currentStep() === 1">Anterior</button>
            </div>
            <div class="footer-right">
              <button type="button" class="btn btn-sm btn-next" *ngIf="!isOnLastStep()" (click)="nextStep()" [disabled]="!canProceedToNextStep()">Siguiente</button>
              <button type="button" class="btn btn-sm btn-save" *ngIf="isOnLastStep()" (click)="onSubmit()" [disabled]="!isFormValid() || isSubmitting()">
                {{ isSubmitting() ? 'Guardando...' : 'Guardar' }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
}
